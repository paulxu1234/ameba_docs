.. _sdk_architecture:

SDK Architecture
--------------------------------
The SDK consists of four parts, as shown in Figure 1-1. The contents and descriptions of each part are summarized in the following sections.

- project

- component

- tools

- doc



Figure - SDK architecture

project
~~~~~~~~~~~~~~
+------------------------+-------------+------------------------------------------+----------------------------------------------------------+
| Item                   | Item        | Description                              | Description                                              |
+========================+=============+==========================================+==========================================================+
| amebadplus_gcc_project | Makefile    | Compile the project with one command     | Compile the project with one command                     |
+------------------------+-------------+------------------------------------------+----------------------------------------------------------+
| amebadplus_gcc_project | menuconfig  | Used to configure the project            | Used to configure the project                            |
+------------------------+-------------+------------------------------------------+----------------------------------------------------------+
| amebadplus_gcc_project | project_km4 | KM4 project files                        | - src/main.c                                             |
|                        |             |                                          |                                                          |
|                        |             |                                          | - inc:                                                   |
|                        |             |                                          |                                                          |
|                        |             |                                          |    - FreeRTOSConfig.h: configure FreeRTOS                |
|                        |             |                                          |                                                          |
|                        |             |                                          |    - main.h                                              |
|                        |             |                                          |                                                          |
|                        |             |                                          |    - platform_autoconf.h: generated by “make menuconfig” |
|                        |             |                                          |                                                          |
|                        |             |                                          |    - platform_opts_bt.h: some utilities for BT           |
|                        |             |                                          |                                                          |
|                        |             |                                          | - Makefile                                               |
|                        |             |                                          |                                                          |
|                        |             |                                          | - Link script                                            |
|                        |             |                                          |                                                          |
|                        |             |                                          | - Bin files                                              |
|                        |             |                                          |                                                          |
|                        |             |                                          | - Library                                                |
|                        |             |                                          |                                                          |
|                        |             |                                          | - ...                                                    |
+------------------------+-------------+------------------------------------------+----------------------------------------------------------+
| amebadplus_gcc_project | project_km0 | KM0 project files                        | - src/main.c                                             |
|                        |             |                                          |                                                          |
|                        |             |                                          | - inc:                                                   |
|                        |             |                                          |                                                          |
|                        |             |                                          |    - FreeRTOSConfig.h: configure FreeRTOS                |
|                        |             |                                          |                                                          |
|                        |             |                                          |    - main.h                                              |
|                        |             |                                          |                                                          |
|                        |             |                                          |    - platform_autoconf.h: generated by “make menuconfig” |
|                        |             |                                          |                                                          |
|                        |             |                                          |    - platform_opts_bt.h: some utilities for BT           |
|                        |             |                                          |                                                          |
|                        |             |                                          | - Makefile                                               |
|                        |             |                                          |                                                          |
|                        |             |                                          | - Link script                                            |
|                        |             |                                          |                                                          |
|                        |             |                                          | - Bin files                                              |
|                        |             |                                          |                                                          |
|                        |             |                                          | - Library                                                |
|                        |             |                                          |                                                          |
|                        |             |                                          | - ...                                                    |
+------------------------+-------------+------------------------------------------+----------------------------------------------------------+
| amebadplus_gcc_project | utils       | J-Link script for connecting KM4 and KM0 | J-Link script for connecting KM4 and KM0                 |
+------------------------+-------------+------------------------------------------+----------------------------------------------------------+

component
~~~~~~~~~~~~~~~~~~
+-------------+----------------------------------------------------------------------------------------------------+
| Items       | Description                                                                                        |
+=============+====================================================================================================+
| at_cmd      | AT commands                                                                                        |
+-------------+----------------------------------------------------------------------------------------------------+
| bluetooth   | BT related source code and library                                                                 |
+-------------+----------------------------------------------------------------------------------------------------+
| example     | Utility examples: audio/network/ota/peripheral example/…                                           |
+-------------+----------------------------------------------------------------------------------------------------+
| file_system | File system: fatfs/littlefs/ftl/kv/vfs…                                                            |
+-------------+----------------------------------------------------------------------------------------------------+
| lwip        | LWIP APIs and driver codes                                                                         |
+-------------+----------------------------------------------------------------------------------------------------+
| network     | - cJSON                                                                                            |
|             |                                                                                                    |
|             | - coap                                                                                             |
|             |                                                                                                    |
|             | - dhcp                                                                                             |
|             |                                                                                                    |
|             | - http2                                                                                            |
|             |                                                                                                    |
|             | - httpc                                                                                            |
|             |                                                                                                    |
|             | - httpd                                                                                            |
|             |                                                                                                    |
|             | - mDNS                                                                                             |
|             |                                                                                                    |
|             | - mqtt                                                                                             |
|             |                                                                                                    |
|             | - ping                                                                                             |
|             |                                                                                                    |
|             | - iperf                                                                                            |
|             |                                                                                                    |
|             | - sntp                                                                                             |
|             |                                                                                                    |
|             | - websocket                                                                                        |
|             |                                                                                                    |
|             | - xml                                                                                              |
+-------------+----------------------------------------------------------------------------------------------------+
| os          | FreeRTOS source codes                                                                              |
+-------------+----------------------------------------------------------------------------------------------------+
| soc         | - app: monitor and shell                                                                           |
|             |                                                                                                    |
|             | - bootloader                                                                                       |
|             |                                                                                                    |
|             | - cmsis: Arm headers, including Arm CPU registers and operations                                   |
|             |                                                                                                    |
|             | - cmsis-dsp: Arm CMSIS-DSP source codes                                                            |
|             |                                                                                                    |
|             | - fwlib: user configuration, low level drivers, such as Audio Codec/SPORTS/UART/I2C/SPI/Timer/PWM… |
|             |                                                                                                    |
|             | - hal: mbed APIs source codes, header files                                                        |
|             |                                                                                                    |
|             | .. only:: RTL8721Dx                                                                                |
|             |                                                                                                    |
|             |                                                                                                    |
|             | - img3: files for image3                                                                           |
|             |                                                                                                    |
|             |                                                                                                    |
|             |                                                                                                    |
|             | - misc: misc file like crashdump/ota/pmu…                                                          |
|             |                                                                                                    |
|             | - swlib: standard software library supported by ROM code, such as _memcpy/_memcmp…                 |
+-------------+----------------------------------------------------------------------------------------------------+
| ssl         | mbed TLS                                                                                           |
+-------------+----------------------------------------------------------------------------------------------------+
| utils       | IPC: util for multicore communication                                                              |
+-------------+----------------------------------------------------------------------------------------------------+
| wifi        | - Wi-Fi driver interface                                                                           |
|             |                                                                                                    |
|             | - Wi-Fi promisc mode interface                                                                     |
|             |                                                                                                    |
|             | - Wi-Fi fast connection                                                                            |
+-------------+----------------------------------------------------------------------------------------------------+

tools
~~~~~~~~~~
+-----------------------+------------------------------------------------------------------+
| Items                 | Description                                                      |
+=======================+==================================================================+
| TraceTool             | Tools used to print logs and send commands                       |
+-----------------------+------------------------------------------------------------------+
| ImageTool             | Image tool                                                       |
+-----------------------+------------------------------------------------------------------+
| DownloadServer        | Used to send image to the device based on socket by OTA function |
+-----------------------+------------------------------------------------------------------+
| DownloadServer (HTTP) | Used to send image to the device based on HTTP by OTA function   |
+-----------------------+------------------------------------------------------------------+
| iperf                 | iperf for Wi-Fi performance test                                 |
+-----------------------+------------------------------------------------------------------+
| littlefs              | Tools to make littlefs file system                               |
+-----------------------+------------------------------------------------------------------+

Critical Header Files
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+------------------+-----------------------------------------------------------------------------+----------------------------------------------+
| Items            | Description                                                                 | Location                                     |
+==================+=============================================================================+==============================================+
| basic_types.h    | - SUCCESS/FAIL                                                              | {SDK}\component\os\os_wrapper\include        |
|                  |                                                                             |                                              |
|                  | - TRUE/FALSE                                                                |                                              |
|                  |                                                                             |                                              |
|                  | - ENABLE/DISABLE                                                            |                                              |
|                  |                                                                             |                                              |
|                  | - ON/OFF                                                                    |                                              |
|                  |                                                                             |                                              |
|                  | - NULL                                                                      |                                              |
|                  |                                                                             |                                              |
|                  | - u8/u16/u32/u64                                                            |                                              |
|                  |                                                                             |                                              |
|                  | - BOOL                                                                      |                                              |
|                  |                                                                             |                                              |
|                  | - BIT\ *x*\                                                                 |                                              |
|                  |                                                                             |                                              |
|                  | - …                                                                         |                                              |
+------------------+-----------------------------------------------------------------------------+----------------------------------------------+
| section_config.h | Section definition used in link script:                                     | {SDK}\component\soc\amebadplus\fwlib\include |
|                  |                                                                             |                                              |
|                  | - BOOT_RAM_DATA_SECTION                                                     |                                              |
|                  |                                                                             |                                              |
|                  | - IMAGE2_RAM_TEXT_SECTION                                                   |                                              |
|                  |                                                                             |                                              |
|                  | - …                                                                         |                                              |
+------------------+-----------------------------------------------------------------------------+----------------------------------------------+
| mbed API headers | Peripheral header files for mbed APIs.                                      | {SDK}\component\soc\amebadplus\hal           |
|                  |                                                                             |                                              |
|                  | If you want to use mbed APIs, related headers must be included.             |                                              |
+------------------+-----------------------------------------------------------------------------+----------------------------------------------+
| ameba_soc.h      | Peripheral header files for raw APIs                                        | {SDK}\component\soc\amebadplus\fwlib\include |
|                  |                                                                             |                                              |
|                  | Raw APIs have more features than mbed APIs, which just have basic features. |                                              |
|                  |                                                                             |                                              |
|                  | If you want to use raw APIs, this header must be included.                  |                                              |
+------------------+-----------------------------------------------------------------------------+----------------------------------------------+




.. _gcc_makefile:

GCC Makefile
------------------------
Makefile Architecture
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Figure 2-1 and Figure 2-2 summary the makefile architectures of each project.



Figure - KM4 makefile architecture



Figure - KM0 makefile architecture

How to Build Library
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The Makefile in \ ``{SDK}\amebadplus_gcc_project\project_km4\asdk\make\project\library``\  is an example to show how to build user library. As shown below, \ ``lib_user.a``\ will be generated in \ ``{SDK}\amebadplus_gcc_project\project_km4\asdk\lib\application``\ .

.. image:: ../_static/sdk_architecture_and_makefile_rst/12792eb9e23267bf2eb985860534b232c8da8939.png
   :width: 575
   :align: center


How to Add Library
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Open the file \ ``{SDK}\amebadplus_gcc_project\project_km4\asdk\Makefile``\ , and append \ ``lib_user.a``\  to LINK_APP_LIB.

.. code::

   LINK_APP_LIB += $(ROOTDIR)/lib/application/lib_user.a


