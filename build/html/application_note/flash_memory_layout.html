<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flash Layout &mdash; AmebaDocs  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            AmebaDocs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
<<<<<<< HEAD
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Flash Layout</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#memory-management-unit-mmu">Memory Management Unit (MMU)</a></li>
<li><a class="reference internal" href="#how-to-modify-flash-layout">How to Modify Flash Layout</a><ul>
<li><a class="reference internal" href="#modifying-bootloader-ota2-location">Modifying Bootloader OTA2 Location</a></li>
<li><a class="reference internal" href="#modifying-app-location">Modifying APP Location</a><ul>
<li><a class="reference internal" href="#app-ota1">APP OTA1</a></li>
<li><a class="reference internal" href="#app-ota2">APP OTA2</a></li>
</ul>
</li>
<li><a class="reference internal" href="#modifying-ftl-vfs-location">Modifying FTL/VFS Location</a></li>
</ul>
</li>
<li><a class="reference internal" href="#flash-protect-enable">Flash Protect Enable</a></li>
</ul>
</li>
<li><a class="reference internal" href="#memory-layout">Memory Layout</a><ul>
<li><a class="reference internal" href="#ram-layout">RAM Layout</a><ul>
<li><a class="reference internal" href="#sram0-first-40kb-layout">SRAM0 (First 40KB) Layout</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-modify-memory-layout">How to Modify Memory Layout</a><ul>
<li><a class="reference internal" href="#modifying-bootloader-size">Modifying Bootloader Size</a></li>
<li><a class="reference internal" href="#modifying-bd-ram-size">Modifying BD_RAM Size</a></li>
<li><a class="reference internal" href="#modifying-bd-psram-size">Modifying BD_PSRAM Size</a></li>
<li><a class="reference internal" href="#extending-heap-size">Extending Heap Size</a></li>
=======
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="gcc_build_environment.html">Build Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="sdk_example.html">SDK Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="mpu_cache.html">MPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="mpu_cache.html#cache">Cache</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Flash Layout</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#memory-management-unit-mmu">Memory Management Unit (MMU)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-modify-flash-layout">How to Modify Flash Layout</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#modifying-bootloader-ota2-location">Modifying Bootloader OTA2 Location</a></li>
<li class="toctree-l3"><a class="reference internal" href="#modifying-app-location">Modifying APP Location</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#app-ota1">APP OTA1</a></li>
<li class="toctree-l4"><a class="reference internal" href="#app-ota2">APP OTA2</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#modifying-ftl-vfs-location">Modifying FTL/VFS Location</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#flash-protect-enable">Flash Protect Enable</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#memory-layout">Memory Layout</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#ram-layout">RAM Layout</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sram0-first-40kb-layout">SRAM0 (First 40KB) Layout</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-modify-memory-layout">How to Modify Memory Layout</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#modifying-bootloader-size">Modifying Bootloader Size</a></li>
<li class="toctree-l3"><a class="reference internal" href="#modifying-bd-ram-size">Modifying BD_RAM Size</a></li>
<li class="toctree-l3"><a class="reference internal" href="#modifying-bd-psram-size">Modifying BD_PSRAM Size</a></li>
<li class="toctree-l3"><a class="reference internal" href="#extending-heap-size">Extending Heap Size</a></li>
>>>>>>> 0e8663f (update files)
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="file_system.html">Virtual File System</a></li>
<li class="toctree-l1"><a class="reference internal" href="ota.html">OTA Firmware Update</a></li>
<li class="toctree-l1"><a class="reference internal" href="mp_image.html">MP Image</a></li>
<li class="toctree-l1"><a class="reference internal" href="boot_process.html">Boot Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_config.html">User Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="power_save.html">Power Saving</a></li>
<li class="toctree-l1"><a class="reference internal" href="template_rst_syntax.html">RST语法</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">AmebaDocs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
<<<<<<< HEAD
=======
          <li class="breadcrumb-item"><a href="index.html">&lt;no title&gt;</a></li>
>>>>>>> 0e8663f (update files)
      <li class="breadcrumb-item active">Flash Layout</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/application_note/flash_memory_layout.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="flash-layout">
<span id="id1"></span><h1>Flash Layout<a class="headerlink" href="#flash-layout" title="Link to this heading"></a></h1>
<p>This chapter introduces the default Flash layout of AmebaDPlus and how to modify the Flash layout if needed.</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>The default Flash layout used in SDK is illustrated in Figure 1-1 and Table 1-1. The layout takes the 8MB Flash as an example. The start address of boot manifest is fixed to 0x0800_0000, and other start addresses can be configured by users flexibly.</p>
<p>Figure 1-1 Flash layout</p>
<p>Table 1-1 Flash layout</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The reserved space can be used by users.</p>
</div>
</section>
<section id="memory-management-unit-mmu">
<h2>Memory Management Unit (MMU)<a class="headerlink" href="#memory-management-unit-mmu" title="Link to this heading"></a></h2>
<p>To achieve flexibility of image and for image encryption when RSIP is enabled (the fixed address is needed by IV when doing image encryption, refer to RSIP for more information), Flash MMU is applied by default. The default MMU layout used in SDK is illustrated in Figure 1-2.</p>
<p>Figure 1-2 Flash MMU layout</p>
</section>
<section id="how-to-modify-flash-layout">
<h2>How to Modify Flash Layout<a class="headerlink" href="#how-to-modify-flash-layout" title="Link to this heading"></a></h2>
<p>The following locations in the Flash can be modified:</p>
<ul>
<li><p>Bootloader OTA2 location</p></li>
<li><p>APP location</p>
<blockquote>
<div><ul class="simple">
<li><p>APP OTA1</p></li>
<li><p>APP OTA2</p></li>
</ul>
</div></blockquote>
</li>
<li><p>FTL/VFS Location</p></li>
</ul>
<section id="modifying-bootloader-ota2-location">
<h3>Modifying Bootloader OTA2 Location<a class="headerlink" href="#modifying-bootloader-ota2-location" title="Link to this heading"></a></h3>
<p>The location of Bootloader OTA2 can be modified but requires 4KB alignment. The Bootloader OTA2 is disabled by default. If you want to enable Bootloader OTA2, shift the start address of Bootloader OTA2 right by 12 bits, then burn it to the OTP 0x36C~0x36D.</p>
<p>The method is to modify the address of <code class="docutils literal notranslate"><span class="pre">IMG_BOOT_OTA2</span></code> in <code class="docutils literal notranslate"><span class="pre">{SDK}\component\soc\amebadplus\usrcfg\ameba_flashcfg.c</span></code>. After burning the Bootloader OTA2 into Flash through OTA, Boot ROM will decide whether to use Bootloader OTA1 or Bootloader OTA2 according to the version number.</p>
<a class="reference internal image-reference" href="../_images/a8921a4f08d70fca0ef51dd3cf89af03c828f1e5.png"><img alt="../_images/a8921a4f08d70fca0ef51dd3cf89af03c828f1e5.png" class="align-center" src="../_images/a8921a4f08d70fca0ef51dd3cf89af03c828f1e5.png" style="width: 1091px;" /></a>
<p>If the anti-rollback function is enabled to ensure that the version of the Bootloader can only be incrementing but cannot be rolled back, the version of the Bootloader needs to be changed before compiling. That is, IMG_VER in <code class="docutils literal notranslate"><span class="pre">{SDK}\amebadplus_gcc_project\manifest.json</span></code> needs to be modified.</p>
<a class="reference internal image-reference" href="../_images/bf0452ef5426e69a5bed57e287657aacdd7fb09c.png"><img alt="../_images/bf0452ef5426e69a5bed57e287657aacdd7fb09c.png" class="align-center" src="../_images/bf0452ef5426e69a5bed57e287657aacdd7fb09c.png" style="width: 365px;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The location of Bootloader OTA1 is fixed to 0x0800_0000, and cannot be modified.</p>
</div>
</section>
<section id="modifying-app-location">
<h3>Modifying APP Location<a class="headerlink" href="#modifying-app-location" title="Link to this heading"></a></h3>
<section id="app-ota1">
<h4>APP OTA1<a class="headerlink" href="#app-ota1" title="Link to this heading"></a></h4>
<p>Follow the steps to modify the location of APP OTA1:</p>
<ol class="arabic simple">
<li><p>Modify the address of IMG_APP_OTA1 in <code class="docutils literal notranslate"><span class="pre">{SDK}\component\soc\amebadplus\usrcfg\ameba_flashcfg.c</span></code>.</p></li>
</ol>
<a class="reference internal image-reference" href="../_images/1b23f396dfc1e8f895577c1286fce88d55447c93.png"><img alt="../_images/1b23f396dfc1e8f895577c1286fce88d55447c93.png" class="align-center" src="../_images/1b23f396dfc1e8f895577c1286fce88d55447c93.png" style="width: 1163px;" /></a>
<ol class="arabic simple" start="2">
<li><p>Re-build the project to generate the Bootloader and APP OTA1.</p></li>
<li><p>Modify the address of <code class="docutils literal notranslate"><span class="pre">km0_km4_app.bin</span></code> if you update the location of APP OTA1 through ImageTool, and download the new Bootloader and APP OTA1.</p></li>
</ol>
<a class="reference internal image-reference" href="../_images/d0357ca252c907fe084a97606147dd5ec1c0a404.png"><img alt="../_images/d0357ca252c907fe084a97606147dd5ec1c0a404.png" class="align-center" src="../_images/d0357ca252c907fe084a97606147dd5ec1c0a404.png" style="width: 1414px;" /></a>
<p>After that, Bootloader will load the image from the new location of APP OTA1 if the version of APP OTA1 is bigger.</p>
</section>
<section id="app-ota2">
<h4>APP OTA2<a class="headerlink" href="#app-ota2" title="Link to this heading"></a></h4>
<ol class="arabic simple">
<li><p>Modify the address of <code class="docutils literal notranslate"><span class="pre">IMG_APP_OTA2</span></code> in <code class="docutils literal notranslate"><span class="pre">{SDK}\component\soc\amebadplus\usrcfg\ameba_flashcfg.c</span></code>.</p></li>
<li><p>Re-build and download the new Bootloader and APP OTA2 as described in section 1.3.2.1 step (2)~(3).</p></li>
</ol>
<a class="reference internal image-reference" href="../_images/85e2ba3eda65b3e93392cc252d88ef84e537b095.png"><img alt="../_images/85e2ba3eda65b3e93392cc252d88ef84e537b095.png" class="align-center" src="../_images/85e2ba3eda65b3e93392cc252d88ef84e537b095.png" style="width: 1092px;" /></a>
<p>After burning the APP OTA2 into Flash through OTA, Bootloader will load the image from the new location of APP OTA2 if the version of APP OTA2 is bigger.</p>
</section>
</section>
<section id="modifying-ftl-vfs-location">
<h3>Modifying FTL/VFS Location<a class="headerlink" href="#modifying-ftl-vfs-location" title="Link to this heading"></a></h3>
<ol class="arabic simple">
<li><p>Modify the addresses of FTL and VFS1 in <code class="docutils literal notranslate"><span class="pre">{SDK}\component\soc\amebadplus\usrcfg\ameba_flashcfg.c</span></code>.</p></li>
<li><p>Update the application image.</p></li>
</ol>
<a class="reference internal image-reference" href="../_images/c69810c4d2f35aa46f86d2b86c75751116554a8d.png"><img alt="../_images/c69810c4d2f35aa46f86d2b86c75751116554a8d.png" class="align-center" src="../_images/c69810c4d2f35aa46f86d2b86c75751116554a8d.png" style="width: 1093px;" /></a>
</section>
</section>
<section id="flash-protect-enable">
<h2>Flash Protect Enable<a class="headerlink" href="#flash-protect-enable" title="Link to this heading"></a></h2>
<p>Before loading APP IMG, the Bootloader will read the Status Register from Flash. If only Quad Enable (QE) Bit is set in the output of bitwise AND between Status Register of Flash and status_mask in Flash_AVL ({SDK}componentsocamebadplususrcfgameba_flashcfg.c), do nothing, or the output of bitwise AND will be written to the Flash Status Register.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By default, setting the QE bit will unlock all the Block Protect Bits. To avoid this operation, set Block Protect bits corresponding to Status_mask in Flash_AVL to 0. For example, change the Status_mask of Winbond in the Flash_AVL to 0x000043C0.</p>
</div>
<a class="reference internal image-reference" href="../_images/06ad55f13b1f04b9cba13d7d3f568a946e88b336.png"><img alt="../_images/06ad55f13b1f04b9cba13d7d3f568a946e88b336.png" class="align-center" src="../_images/06ad55f13b1f04b9cba13d7d3f568a946e88b336.png" style="width: 1128px;" /></a>
<p>In order to avoid the image being damaged due to improper operation when using LittleFS to write user data, it is recommended to modify the location of FTL/LittleFS to the last 64KB area of Flash, and set the Block Protect Bit in the Status Register of Flash at the same time.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>Only the last 64KB area of Flash can be modified, and the other areas are protected. Remember to unlock the Flash during OTA upgrade, and keep it locked when OTA is completed.</p></li>
<li><p>For some Flashes, you cannot set the Flash to allow only the last block to be modified through Block Protect Bit. In this case, it is recommended to enable the Flash block protection of the first half part.</p></li>
</ul>
</div>
</section>
</section>
<section id="memory-layout">
<span id="id2"></span><h1>Memory Layout<a class="headerlink" href="#memory-layout" title="Link to this heading"></a></h1>
<p>This chapter introduces the default memory layout of AmebaDPlus and how to modify the memory layout if needed.</p>
<section id="ram-layout">
<h2>RAM Layout<a class="headerlink" href="#ram-layout" title="Link to this heading"></a></h2>
<p>In total, there are 512KB SRAM on chip, and the size of PSRAM can be 0MB/4MB/8MB/16MB…, which is decided by users. The RAM layout is illustrated in Figure 2-1.</p>
<p>Figure 2-1 RAM layout</p>
<section id="sram0-first-40kb-layout">
<h3>SRAM0 (First 40KB) Layout<a class="headerlink" href="#sram0-first-40kb-layout" title="Link to this heading"></a></h3>
<p>The first 40KB SRAM0 layout is illustrated in Table 2-1Figure 2-2 and Table 2-1. It is the same for all situations.</p>
<p>Figure 2-2 SRAM0 (first 40KB) layout</p>
<p>Table 2-1 SRAM0 (first 40KB) layout</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Items</p></th>
<th class="head"><p>Start address</p></th>
<th class="head"><p>Size</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Mandatory</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>KM0_ROM_BSS_RAM</p></td>
<td><p>0x2000_0000</p></td>
<td><p>4KB</p></td>
<td><p>KM0 ROM BSS</p></td>
<td><p>√</p></td>
</tr>
<tr class="row-odd"><td><p>KM0_MSP_RAM</p></td>
<td><p>0x2000_1000</p></td>
<td><p>4KB</p></td>
<td><p>KM0 Main Stack Pointer</p></td>
<td><p>√</p></td>
</tr>
<tr class="row-even"><td><p>KM0_STDLIB_HEAP_NS</p></td>
<td><p>0x2000_2000</p></td>
<td><p>4KB</p></td>
<td><p>KM0 ROM STDLIB heap</p></td>
<td><p>√</p></td>
</tr>
<tr class="row-odd"><td><p>KM4_MSP_NS</p></td>
<td><p>0x2000_3000</p></td>
<td><p>4KB</p></td>
<td><p>KM4 non-secure Main Stack Pointer</p></td>
<td><p>√</p></td>
</tr>
<tr class="row-even"><td><p>KM4_ROM_BSS_COMMON</p></td>
<td><p>0x2000_4000</p></td>
<td><p>3.25KB</p></td>
<td><p>KM4 ROM secure and non-secure common BSS</p></td>
<td><p>√</p></td>
</tr>
<tr class="row-odd"><td><p>KM0_BOOT_RAM</p></td>
<td><p>0x2000_4D00</p></td>
<td><p>64B</p></td>
<td><p>KM0 IMG2 entry</p></td>
<td><p>√</p></td>
</tr>
<tr class="row-even"><td><p>KM0_IPC_RAM</p></td>
<td><p>0x2000_4E00</p></td>
<td><p>512B</p></td>
<td><p>Exchange messages between cores</p></td>
<td><p>√</p></td>
</tr>
<tr class="row-odd"><td><p>KM4_ROM_BSS_NS</p></td>
<td><p>0x2000_5000</p></td>
<td><p>4KB</p></td>
<td><p>KM4 ROM non-secure common BSS</p></td>
<td><p>√</p></td>
</tr>
<tr class="row-even"><td><p>KM4_STDLIB_HEAP_NS</p></td>
<td><p>0x2000_6000</p></td>
<td><p>4KB</p></td>
<td><p>KM4 ROM non-secure STDLIB heap</p></td>
<td><p>√</p></td>
</tr>
<tr class="row-odd"><td><p>KM4_ROM_BSS_S</p></td>
<td><p>0x3000_7000</p></td>
<td><p>4KB</p></td>
<td><p>KM4 ROM secure-only BSS</p></td>
<td><p>√</p></td>
</tr>
<tr class="row-even"><td><p>KM0_RTOS_STATIC_0_NS</p></td>
<td><p>0x2000_8000</p></td>
<td><p>4KB</p></td>
<td><p>KM0 RTOS static pool position</p></td>
<td><p>√</p></td>
</tr>
<tr class="row-odd"><td><p>KM4_MSP_S</p></td>
<td><p>0x3000_9000</p></td>
<td><p>4KB</p></td>
<td><p>KM4 secure Main Stack Pointer</p></td>
<td><p>√</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="how-to-modify-memory-layout">
<h2>How to Modify Memory Layout<a class="headerlink" href="#how-to-modify-memory-layout" title="Link to this heading"></a></h2>
<p>The following memory size can be modified.</p>
<ul class="simple">
<li><p>Bootloader</p></li>
<li><p>BD_RAM</p></li>
<li><p>BD_PSRAM</p></li>
<li><p>Heap</p></li>
</ul>
<section id="modifying-bootloader-size">
<h3>Modifying Bootloader Size<a class="headerlink" href="#modifying-bootloader-size" title="Link to this heading"></a></h3>
<p>If you need to enlarge the size of KM4_BOOT_RAM_S, the modified KM4_BOOT_RAM_S size should be 4KB aligned because the MPC protection is protected in unit 4KB.</p>
<p>Follow the steps to modify the size of Bootloader:</p>
<ol class="arabic simple">
<li><p>Modify the CONFIG Link Option in menuconfig to choose whether to place the Bootloader (IMG1) on FLASH or SRAM. When SRAM is selected, the size of KM4_BOOTLOADER_RAM_S is 24K; when FLASH is selected, the size of KM4_BOOTLOADER_RAM_S is 4K.</p></li>
</ol>
<a class="reference internal image-reference" href="../_images/317a7635d2df4eaa61d78e8bd0fb8e748bbaa79a.png"><img alt="../_images/317a7635d2df4eaa61d78e8bd0fb8e748bbaa79a.png" class="align-center" src="../_images/317a7635d2df4eaa61d78e8bd0fb8e748bbaa79a.png" style="width: 455px;" /></a>
<ol class="arabic simple" start="2">
<li><p>By modifying KM4_IMG1_SIZE in <code class="docutils literal notranslate"><span class="pre">{SDK}\amebadplus_gcc_project\amebaDplus_layout.ld</span></code>, users can change the size of the KM4 BOOTLOADER RAM S.</p></li>
</ol>
<a class="reference internal image-reference" href="../_images/a27a4eb43a21e2e823270f1862da74effe17d3e5.png"><img alt="../_images/a27a4eb43a21e2e823270f1862da74effe17d3e5.png" class="align-center" src="../_images/a27a4eb43a21e2e823270f1862da74effe17d3e5.png" style="width: 408px;" /></a>
<ol class="arabic simple" start="3">
<li><p>Re-build the project to generate the Bootloader.</p></li>
<li><p>Modify the end address of km4_boot_all.bin if Bootloader is too large, and download the new Bootloader.</p></li>
</ol>
<a class="reference internal image-reference" href="../_images/4ed6c24886cfdf50ebec90c4fe8a899a6883167d.png"><img alt="../_images/4ed6c24886cfdf50ebec90c4fe8a899a6883167d.png" class="align-center" src="../_images/4ed6c24886cfdf50ebec90c4fe8a899a6883167d.png" style="width: 1821px;" /></a>
<p>After that, Boot ROM will load the new Bootloader if the version of new Bootloader is bigger.</p>
</section>
<section id="modifying-bd-ram-size">
<h3>Modifying BD_RAM Size<a class="headerlink" href="#modifying-bd-ram-size" title="Link to this heading"></a></h3>
<p>Follow the steps to modify the size of KM4 BD RAM:</p>
<ol class="arabic simple">
<li><p>Users can change the KM4 BD RAM size by modifying RAM_KM0_IMG2_SIZE in <code class="docutils literal notranslate"><span class="pre">{SDK}\amebadplus_gcc_project\amebaDplus_</span> <span class="pre">layout.ld</span></code> to change the end address of KM4_BD_RAM.</p></li>
</ol>
<a class="reference internal image-reference" href="../_images/c014baacb7498076fda32fee1380dce15b8f3d39.png"><img alt="../_images/c014baacb7498076fda32fee1380dce15b8f3d39.png" class="align-center" src="../_images/c014baacb7498076fda32fee1380dce15b8f3d39.png" style="width: 399px;" /></a>
<ol class="arabic simple" start="2">
<li><p>Re-build and download the new Bootloader and IMG2 OTA2 as described in Section 1.3.2.1 step (2)~(3).</p></li>
</ol>
</section>
<section id="modifying-bd-psram-size">
<h3>Modifying BD_PSRAM Size<a class="headerlink" href="#modifying-bd-psram-size" title="Link to this heading"></a></h3>
<p>If user wants to modify the KM4 BD PSRAM size, please modify the running position of IMG2 in menuconfig first. Any option with PSRAM is acceptable. Then modify PSRAM_KM4_IMG2_SIZE in <code class="docutils literal notranslate"><span class="pre">{SDK}\amebadplus_gcc_project\amebaDplus_layout.ld</span></code> to change the end address of KM4_BD_PSRAM.</p>
<a class="reference internal image-reference" href="../_images/68e1672a9be0e0bdb3ec171e30264a4bddbe51ae.png"><img alt="../_images/68e1672a9be0e0bdb3ec171e30264a4bddbe51ae.png" class="align-center" src="../_images/68e1672a9be0e0bdb3ec171e30264a4bddbe51ae.png" style="width: 985px;" /></a>
</section>
<section id="extending-heap-size">
<h3>Extending Heap Size<a class="headerlink" href="#extending-heap-size" title="Link to this heading"></a></h3>
<p>The heap size consists of multi-blocks and is passed to the operating system by the os_heap_init() function in componentosfreertosfreertos_heap5_config.c. By default, PSRAM_HEAP1_START is invalid address and PSRAM_HEAP1_SIZE is 0.</p>
<a class="reference internal image-reference" href="../_images/a92d39c85a6c25045fb56f51b199e3ca3bc25a9f.png"><img alt="../_images/a92d39c85a6c25045fb56f51b199e3ca3bc25a9f.png" class="align-center" src="../_images/a92d39c85a6c25045fb56f51b199e3ca3bc25a9f.png" style="width: 1020px;" /></a>
<p>If the heap of KM4 is not enough, define Heap Start and Heap Size for some unused areas in amebaDplus_layout.ld, and then use the os_heap_add function to add the area to the heap array. The address shall be a valid value in PSRAM, then re-build and download the new image to let KM4 use the extended heap.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">bool</span> <span class="n">os_heap_add</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">start_addr</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">heap_size</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The symbols defined in linker script (amebaDplus_layout.ld) need to be declared in ameba_boot.h before they can be used.</p>
</div>
<p>If KM0 heap is not enough, modify the KM0_PSRAM_HEAP_EXT accordingly.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, claire_wang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>